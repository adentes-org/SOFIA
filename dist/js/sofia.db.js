"use strict";var S=S||{},req_limit=1e6;PouchDB.debug.disable(),S.db={setUrl:function(e){S.config.db=e,localStorage["sofia-server-config"]=JSON.stringify(S.config.db),S.config.db._full_url=S.config.db.url.replace(/\/+$/,"")+"/"+S.config.db.name.replace(/^\/+/,""),S.config.db._local_url="local-"+S.config.db._full_url.replace(/:/gi,"").replace(/\/+/gi,"#"),S.db.localDB=new PouchDB(S.config.db._local_url),S.db.remoteDB=new PouchDB(S.config.db._full_url,{skipSetup:!0})},clearLocal:function(){return S.db.localDB.destroy()}},S.db.setUrl(S.config.db),S.db.config={getUsers:function(){var e=new $.Deferred;return S.db.localDB.get("_design/sofia-config").then(function(o){console.log(e.resolve(o.users||[]))})["catch"](function(e){console.log(e)}),e.promise()},getMemo:function(){var e=new $.Deferred;return S.db.localDB.getAttachment("_design/sofia-config","memo.html").then(function(o){var n=new FileReader;n.onload=function(){e.resolve({memo:n.result})},n.readAsText(o)})["catch"](function(e){console.log(e)}),e.promise()}},S.db.users={login:function(e,o,n){var t=new $.Deferred;return S.db.remoteDB.login(e,o,function(c,i){c?(console.log(c),n||navigator.notification.alert(c.message),t.reject(c)):i.ok&&(console.log("We are logged in !",i),S.user.set(e,o,i),S.db.fiches.startSync(),t.resolve(i))}),t.promise()}},S.db.fiches={changeToParse:0,parseSync:function(e){switch(console.log("Parsing sync : ",e),S.vue.router.app.$children[0].$data.options.displayLoadingBar=!1,console.log("Currently shown page : ",window.location.hash.slice(3).split("/")[0]),window.location.hash.slice(3).split("/")[0]){case"memo":S.db.config.getMemo().then(function(e){S.vue.router.app.$children[1].$data.memo=e.memo,console.log("Updating memo data : ",e)});break;case"home":S.db.fiches.getAllWithMine().then(function(e){S.vue.router.app.$children[1].$data.fiches=e.fiches,S.vue.router.app.$children[1].$data.my_fiches=e.my_fiches,console.log("Updating home data : ",e)});break;case"fiche":var o=window.location.hash.slice(3).split("/")[1];S.db.fiches.getByID(o).then(function(e){S.vue.router.app.$children[1].$data.fiche=e,S.vue.router.app.$children[0].$data.options.title=e.patient.firstname+" "+e.patient.lastname});break;default:S.vue.router.replace(window.location.hash.slice(2))}S.db.fiches.changeToParse>0&&S.db.fiches.changeToParse--},watch:function(e){e.on("change",function(e){S.db.fiches.changeToParse++,console.log("Pouchdb.sync.change event",e,Date())}).on("paused",function(e){console.log("Pouchdb.sync.paused event",e,Date()),S.vue.router.app.$children[0].$data.options.backColor!==S.config.header.backColor?(console.log("Setting header color to online"),S.vue.router.app.$children[0].$data.options.backColor=S.config.header.backColor):(S.db.fiches.offlineTimeout&&(console.log("Clearing offline timeout"),window.clearTimeout(S.db.fiches.offlineTimeout)),S.db.fiches.offlineTimeout=window.setTimeout("console.log('Setting header color to offline');S.vue.router.app.$children[0].$data.options.backColor = S.config.header.backColorOffline;",1e3*S.config.header.timeoutOffline)),(S.db.fiches.changeToParse>0||S.vue.router.app.$children[0].$data.options.displayLoadingBar)&&S.db.fiches.parseSync(e)}).on("active",function(e){console.log("Pouchdb.sync.active event",e,Date()),S.vue.router.app.$children[0].$data.options.displayLoadingBar=!0}).on("error",function(e){console.log("Pouchdb.sync.error event",e,Date())}).on("complete",function(e){console.log("Pouchdb.sync.complete event",e,Date()),S.db.fiches.watch(S.db.localDB.sync(S.db.remoteDB,{live:!0,retry:!0}))})},startSync:function(){console.log("Starting sync ..."),S.db.fiches.watch(S.db.localDB.sync(S.db.remoteDB,{live:!0,retry:!0})),console.log("Sync in place !")},post:function(e){return S.db.localDB.post(e)},put:function(e){return e.pathologys=S.tool.uniq(e.pathologys),S.db.localDB.put(e)["catch"](function(e){console.log(e),409===e.status})},getByID:function(e){var o=new $.Deferred;return S.db.localDB.get(e).then(function(e){console.log(e),o.resolve(e)})["catch"](function(e){console.log(e),o.reject(e)}),o.promise()},filterMine:function(e){var o=[];return $.each(e,function(e,n){n.owner_id===S.user._current.name&&(o[o.length]=n)}),o},getAllWithMine:function(){var e=new $.Deferred;return S.db.fiches.getAll().then(function(o){o.my_fiches=S.db.fiches.filterMine(o.fiches),e.resolve(o)}),e.promise()},getAll:function(){var e=new $.Deferred;return S.db.localDB.allDocs({include_docs:!0,skip:0,limit:req_limit}).then(function(o){var n={user:S.user._current,fiches:[]};$.each(o.rows,function(e,o){if("_design"!==o.doc._id.split("/")[0]){n.fiches[n.fiches.length]=o.doc,o.doc.last_update=o.doc.events[o.doc.events.length-1].timestamp;var t=moment(o.doc.last_update);o.doc.last_update_since=t.fromNow(),o.doc.last_update_is_old=t.add(3,"hours").isBefore();var c=moment(o.doc.patient.birthdate);o.doc.patient.age=moment().diff(c,"years"),o.doc.patient.age_formatted=c.fromNow(!0)}}),n.lang=S.lang,e.resolve(n)})["catch"](function(o){console.log(o),e.reject(o)}),e.promise()},getMyCreationCount:function(){var e=new $.Deferred;return S.db.localDB.allDocs({include_docs:!0,skip:0,limit:req_limit}).then(function(o){var n=0;$.each(o.rows,function(e,o){"_design"!==o.doc._id.split("/")[0]&&o.doc.uid.split("-")[0]===S.user._current.name&&n++}),console.log(n),e.resolve(n)})["catch"](function(o){console.log(o),e.reject(o)}),e.promise()}};